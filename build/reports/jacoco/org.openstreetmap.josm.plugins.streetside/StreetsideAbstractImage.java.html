<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StreetsideAbstractImage.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MicrosoftStreetside</a> &gt; <a href="index.source.html" class="el_package">org.openstreetmap.josm.plugins.streetside</a> &gt; <span class="el_source">StreetsideAbstractImage.java</span></div><h1>StreetsideAbstractImage.java</h1><pre class="source lang-java linenums">// License: GPL. For details, see LICENSE file.
package org.openstreetmap.josm.plugins.streetside;

import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.Locale;

import org.openstreetmap.josm.data.coor.LatLon;
import org.openstreetmap.josm.plugins.streetside.utils.StreetsideProperties;

/**
 * Abstract superclass for all image objects. At the moment there are just 2,
 * {@link StreetsideImportedImage} and {@link StreetsideImage}.
 *
 * @author nokutu
 *
 */
public abstract class StreetsideAbstractImage implements Comparable&lt;StreetsideAbstractImage&gt; {
	/**
	 * If two values for field cd differ by less than EPSILON both values are
	 * considered equal.
	 */
	private static final float EPSILON = 1e-5f;

	protected String id;

	/** The time the image was captured, in Epoch format. */
	protected long cd;
	/** Sequence of pictures containing this object. */
	private StreetsideSequence sequence;

	/** Position of the picture. */
	protected LatLon latLon;
	/** Direction of the picture. */
	protected double he;
	/** Temporal position of the picture until it is uploaded. */
	private LatLon tempLatLon;
	/**
	 * When the object is being dragged in the map, the temporal position is stored
	 * here.
	 */
	private LatLon movingLatLon;
	/** Temporal direction of the picture until it is uploaded */
	private double tempHe;
	/**
	 * When the object direction is being moved in the map, the temporal direction
	 * is stored here
	 */
	protected double movingHe;
	/** Whether the image must be drown in the map or not */
	private boolean visible;

	/**
	 * Creates a new object in the given position and with the given direction.
	 * {@link LatLon}
	 *
	 * @param id - the Streetside image id
	 *
	 * @param latLon
	 *            The latitude and longitude of the image.
	 * @param he
	 *            The direction of the picture (0 means north im Mapillary
	 *            camera direction is not yet supported in the Streetside plugin).
	 */
<span class="fc" id="L66">	protected StreetsideAbstractImage(final String id, final LatLon latLon, final double he) {</span>
<span class="fc" id="L67">		this.id = id;</span>
<span class="fc" id="L68">		this.latLon = latLon;</span>
<span class="fc" id="L69">		tempLatLon = this.latLon;</span>
<span class="fc" id="L70">		movingLatLon = this.latLon;</span>
<span class="fc" id="L71">		this.he = he;</span>
<span class="fc" id="L72">		tempHe = he;</span>
<span class="fc" id="L73">		movingHe = he;</span>
<span class="fc" id="L74">		visible = true;</span>
<span class="fc" id="L75">	}</span>

	/**
	 * Creates a new object with the given id.
	 *
	 * @param id - the image id (All images require ids in Streetside)
	 */
<span class="nc" id="L82">	protected StreetsideAbstractImage(final String id) {</span>
<span class="nc" id="L83">		this.id = id;</span>

<span class="nc" id="L85">		visible = true;</span>
<span class="nc" id="L86">	}</span>

	/**
	 * @return the id
	 */
	public String getId() {
<span class="nc" id="L92">		return id;</span>
	}

	/**
	 * @param id
	 *            the id to set
	 */
	public void setId(String id) {
<span class="nc" id="L100">		this.id = id;</span>
<span class="nc" id="L101">	}</span>

	/**
	 * Returns the original direction towards the image has been taken.
	 *
	 * @return The direction of the image (0 means north and goes clockwise).
	 */
	public double getHe() {
<span class="nc" id="L109">		return he;</span>
	}

	/**
	 * Returns the Epoch time when the image was captured.
	 *
	 * @return The long containing the Epoch time when the image was captured.
	 */
	public long getCd() {
<span class="nc" id="L118">		return cd;</span>
	}

	/**
	 * Returns the date the picture was taken in DMY format.
	 *
	 * @return A String object containing the date when the picture was taken.
	 */
	public String getDate() {
<span class="nc" id="L127">		final StringBuilder format = new StringBuilder(26);</span>
<span class="nc" id="L128">		format.append(&quot;m/d/YYYY&quot;);</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">		if (StreetsideProperties.DISPLAY_HOUR.get()) {</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">			if (StreetsideProperties.TIME_FORMAT_24.get()) {</span>
<span class="nc" id="L131">				format.append(&quot; - HH:mm:ss&quot;);</span>
			} else {
<span class="nc" id="L133">				format.append(&quot; - h:mm:ss a&quot;);</span>
			}
		}
<span class="nc" id="L136">		return getDate(format.toString());</span>
	}

	/**
	 * Returns the date the picture was taken in the given format.
	 *
	 * @param format
	 *            Format of the date. See {@link SimpleDateFormat}.
	 * @return A String containing the date the picture was taken using the given
	 *         format.
	 * @throws NullPointerException
	 *             if parameter format is &lt;code&gt;null&lt;/code&gt;
	 */
	public String getDate(String format) {
<span class="nc" id="L150">		final Date date = new Date(getCd());</span>
<span class="nc" id="L151">		final SimpleDateFormat formatter = new SimpleDateFormat(format, Locale.US);</span>
<span class="nc" id="L152">		formatter.setTimeZone(Calendar.getInstance().getTimeZone());</span>
<span class="nc" id="L153">		return formatter.format(date);</span>
	}

	/**
	 * Returns a LatLon object containing the original coordinates of the object.
	 *
	 * @return The LatLon object with the position of the object.
	 */
	public LatLon getLatLon() {
<span class="nc" id="L162">		return latLon;</span>
	}

	/**
	 * Returns the direction towards the image has been taken.
	 *
	 * @return The direction of the image (0 means north and goes clockwise).
	 */
	public double getMovingHe() {
<span class="fc" id="L171">		return movingHe;</span>
	}

	/**
	 * Returns a LatLon object containing the current coordinates of the object.
	 * When you are dragging the image this changes.
	 *
	 * @return The LatLon object with the position of the object.
	 */
	public LatLon getMovingLatLon() {
<span class="fc" id="L181">		return movingLatLon;</span>
	}

	/**
	 * Returns the sequence which contains this image. Never null.
	 *
	 * @return The StreetsideSequence object that contains this StreetsideImage.
	 */

	public StreetsideSequence getSequence() {
<span class="fc" id="L191">		synchronized (this) {</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">			if (sequence == null) {</span>
<span class="fc" id="L193">				sequence = new StreetsideSequence();</span>
<span class="fc" id="L194">				sequence.add(this);</span>
			}
<span class="fc" id="L196">			return sequence;</span>
<span class="nc" id="L197">		}</span>
	}

	/**
	 * Returns the last fixed direction of the object.
	 *
	 * @return The last fixed direction of the object. 0 means north.
	 */
	public double getTempHe() {
<span class="nc" id="L206">		return tempHe;</span>
	}

	/**
	 * Returns the last fixed coordinates of the object.
	 *
	 * @return A LatLon object containing.
	 */
	public LatLon getTempLatLon() {
<span class="nc" id="L215">		return tempLatLon;</span>
	}

	/**
	 * Returns whether the object has been modified or not.
	 *
	 * @return true if the object has been modified; false otherwise.
	 */
	public boolean isModified() {
<span class="fc bfc" id="L224" title="All 4 branches covered.">		return !getMovingLatLon().equals(latLon) || Math.abs(getMovingHe() - cd) &gt; EPSILON;</span>
	}

	/**
	 * Returns whether the image is visible on the map or not.
	 *
	 * @return True if the image is visible; false otherwise.
	 */
	public boolean isVisible() {
<span class="nc" id="L233">		return visible;</span>
	}

	/**
	 * Moves the image temporally to another position
	 *
	 * @param x
	 *            The movement of the image in longitude units.
	 * @param y
	 *            The movement of the image in latitude units.
	 */
	public void move(final double x, final double y) {
<span class="fc" id="L245">		movingLatLon = new LatLon(tempLatLon.getY() + y, tempLatLon.getX() + x);</span>
<span class="fc" id="L246">	}</span>

	/**
	 * If the StreetsideImage belongs to a StreetsideSequence, returns the next
	 * image in the sequence.
	 *
	 * @return The following StreetsideImage, or null if there is none.
	 */
	public StreetsideAbstractImage next() {
<span class="fc" id="L255">		synchronized (this) {</span>
<span class="fc" id="L256">			return getSequence().next(this);</span>
<span class="nc" id="L257">		}</span>
	}

	/**
	 * If the StreetsideImage belongs to a StreetsideSequence, returns the previous
	 * image in the sequence.
	 *
	 * @return The previous StreetsideImage, or null if there is none.
	 */
	public StreetsideAbstractImage previous() {
<span class="fc" id="L267">		synchronized (this) {</span>
<span class="fc" id="L268">			return getSequence().previous(this);</span>
<span class="nc" id="L269">		}</span>
	}

	public void setHe(final double he) {
<span class="nc" id="L273">		this.he = he;</span>
<span class="nc" id="L274">	}</span>

	/**
	 * Sets the Epoch time when the picture was captured.
	 *
	 * @param cd
	 *            Epoch time when the image was captured.
	 */
	public synchronized void setCd(final long cd) {
<span class="nc" id="L283">		this.cd = cd;</span>
<span class="nc" id="L284">	}</span>

	public void setLatLon(final LatLon latLon) {
<span class="nc bnc" id="L287" title="All 2 branches missed.">		if (latLon != null) {</span>
<span class="nc" id="L288">			this.latLon = latLon;</span>
		}
<span class="nc" id="L290">	}</span>

	/**
	 * Sets the StreetsideSequence object which contains the StreetsideImage.
	 *
	 * @param sequence
	 *            The StreetsideSequence that contains the StreetsideImage.
	 * @throws IllegalArgumentException
	 *             if the image is not already part of the
	 *             {@link StreetsideSequence}. Call
	 *             {@link StreetsideSequence#add(StreetsideAbstractImage)} first.
	 */
	public void setSequence(final StreetsideSequence sequence) {
<span class="fc" id="L303">		synchronized (this) {</span>
<span class="pc bpc" id="L304" title="2 of 4 branches missed.">			if (sequence != null &amp;&amp; !sequence.getImages().contains(this)) {</span>
<span class="nc" id="L305">				throw new IllegalArgumentException();</span>
			}
<span class="fc" id="L307">			this.sequence = sequence;</span>
<span class="pc" id="L308">		}</span>
<span class="fc" id="L309">	}</span>

	/**
	 * Set's whether the image should be visible on the map or not.
	 *
	 * @param visible
	 *            true if the image is set to be visible; false otherwise.
	 */
	public void setVisible(final boolean visible) {
<span class="nc" id="L318">		this.visible = visible;</span>
<span class="nc" id="L319">	}</span>

	/**
	 * Called when the mouse button is released, meaning that the picture has
	 * stopped being dragged, so the temporal values are saved.
	 */
	public void stopMoving() {
<span class="fc" id="L326">		tempLatLon = movingLatLon;</span>
<span class="fc" id="L327">		tempHe = movingHe;</span>
<span class="fc" id="L328">	}</span>

	/**
	 * Turns the image direction.
	 *
	 * @param ca
	 *            The angle the image is moving.
	 */
	public void turn(final double ca) {
<span class="fc" id="L337">		movingHe = tempHe + ca;</span>
<span class="fc" id="L338">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>