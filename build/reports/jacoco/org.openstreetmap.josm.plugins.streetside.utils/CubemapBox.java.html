<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CubemapBox.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MicrosoftStreetside</a> &gt; <a href="index.source.html" class="el_package">org.openstreetmap.josm.plugins.streetside.utils</a> &gt; <span class="el_source">CubemapBox.java</span></div><h1>CubemapBox.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

package org.openstreetmap.josm.plugins.streetside.utils;

import java.awt.image.BufferedImage;

import org.openstreetmap.josm.plugins.streetside.cubemap.CubemapUtils;
import org.openstreetmap.josm.plugins.streetside.cubemap.GraphicsUtils;

import javafx.animation.AnimationTimer;
import javafx.beans.property.DoubleProperty;
import javafx.beans.property.SimpleDoubleProperty;
import javafx.geometry.Rectangle2D;
import javafx.scene.Group;
import javafx.scene.PerspectiveCamera;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.image.WritableImage;
import javafx.scene.transform.Affine;
import javafx.scene.transform.Rotate;
import javafx.scene.transform.Transform;

/**
 *
 * @author Dub
 * @author renerr18
 */
@SuppressWarnings(&quot;restriction&quot;)
public  class CubemapBox extends Group{

<span class="nc" id="L35">	public enum CubemapBoxImageType{</span>
<span class="nc" id="L36">        MULTIPLE, SINGLE</span>
    }

<span class="nc" id="L39">    private final Affine affine = new Affine();</span>

<span class="nc" id="L41">    private final ImageView</span>
    front = new ImageView(),
	right = new ImageView(),
	back  = new ImageView(),
	left  = new ImageView(),
    up    = new ImageView(),
    down  = new ImageView();

    {
<span class="nc" id="L50">    	front.setId(CubemapUtils.CubemapFaces.FRONT.getValue());</span>
<span class="nc" id="L51">    	right.setId(CubemapUtils.CubemapFaces.RIGHT.getValue());</span>
<span class="nc" id="L52">    	back.setId(CubemapUtils.CubemapFaces.BACK.getValue());</span>
<span class="nc" id="L53">    	left.setId(CubemapUtils.CubemapFaces.LEFT.getValue());</span>
<span class="nc" id="L54">    	up.setId(CubemapUtils.CubemapFaces.UP.getValue());</span>
<span class="nc" id="L55">        down .setId(CubemapUtils.CubemapFaces.DOWN.getValue());</span>

    }
<span class="nc" id="L58">    private final ImageView[] views = new ImageView[]{</span>
    	front,
    	right,
    	back,
    	left,
    	up,
        down
    };

	private Image
		frontImg, rightImg, backImg, leftImg, upImg, downImg, singleImg;

	//private WritableImage convertedImage;

    private final PerspectiveCamera camera;
    private AnimationTimer timer;
    private final CubemapBoxImageType imageType;

    public CubemapBox(Image singleImg, double size, PerspectiveCamera camera) {
<span class="nc" id="L77">        super();</span>
<span class="nc" id="L78">        imageType = CubemapBoxImageType.SINGLE;</span>

<span class="nc" id="L80">        this.singleImg = singleImg;</span>
<span class="nc" id="L81">        this.size.set(size);</span>
<span class="nc" id="L82">        this.camera = camera;</span>

<span class="nc" id="L84">        getTransforms().add(affine);</span>

<span class="nc" id="L86">        loadImageViews();</span>

<span class="nc" id="L88">        getChildren().addAll(views);</span>
<span class="nc" id="L89">    }</span>

    // private constructor to prevent instantiation
    public CubemapBox(double size, PerspectiveCamera camera) {
<span class="nc" id="L93">        super();</span>
<span class="nc" id="L94">        imageType = CubemapBoxImageType.SINGLE;</span>

<span class="nc" id="L96">        this.size.set(size);</span>
<span class="nc" id="L97">        this.camera = camera;</span>

<span class="nc" id="L99">        getTransforms().add(affine);</span>

<span class="nc" id="L101">        loadImageViews();</span>

<span class="nc" id="L103">        getChildren().addAll(views);</span>
<span class="nc" id="L104">    }</span>

    public CubemapBox(Image frontImg, Image rightImg, Image backImg, Image leftImg, Image upImg, Image downImg, double size, PerspectiveCamera camera) {
<span class="nc" id="L107">        super();</span>
<span class="nc" id="L108">        imageType = CubemapBoxImageType.MULTIPLE;</span>

<span class="nc" id="L110">        this.frontImg = frontImg;</span>
<span class="nc" id="L111">        this.rightImg = rightImg;</span>
<span class="nc" id="L112">        this.backImg = backImg;</span>
<span class="nc" id="L113">        this.leftImg = leftImg;</span>
<span class="nc" id="L114">        this.upImg = upImg;</span>
<span class="nc" id="L115">        this.downImg = downImg;</span>
<span class="nc" id="L116">        this.size.set(size);</span>
<span class="nc" id="L117">        this.camera = camera;</span>

<span class="nc" id="L119">        loadImageViews();</span>

<span class="nc" id="L121">        getTransforms().add(affine);</span>

<span class="nc" id="L123">        getChildren().addAll(views);</span>

<span class="nc" id="L125">        startTimer();</span>
<span class="nc" id="L126">    }</span>

    public void loadImageViews(){

<span class="nc bnc" id="L130" title="All 2 branches missed.">        for(ImageView iv : views){</span>
<span class="nc" id="L131">            iv.setSmooth(true);</span>
<span class="nc" id="L132">            iv.setPreserveRatio(true);</span>
        }

<span class="nc" id="L135">        validateImageType();</span>
<span class="nc" id="L136">    }</span>

    private void layoutViews() {

<span class="nc bnc" id="L140" title="All 2 branches missed.">    	for(ImageView v : views){</span>
<span class="nc" id="L141">            v.setFitWidth(getSize());</span>
<span class="nc" id="L142">            v.setFitHeight(getSize());</span>
        }

<span class="nc" id="L145">        back.setTranslateX(-0.5 * getSize());</span>
<span class="nc" id="L146">        back.setTranslateY(-0.5 * getSize());</span>
<span class="nc" id="L147">        back.setTranslateZ(-0.5 * getSize());</span>

<span class="nc" id="L149">        front.setTranslateX(-0.5 * getSize());</span>
<span class="nc" id="L150">        front.setTranslateY(-0.5 * getSize());</span>
<span class="nc" id="L151">        front.setTranslateZ(0.5 * getSize());</span>
<span class="nc" id="L152">        front.setRotationAxis(Rotate.Z_AXIS);</span>
<span class="nc" id="L153">        front.setRotate(-180);</span>
<span class="nc" id="L154">        front.getTransforms().add(new Rotate(180,front.getFitHeight() / 2, 0,0, Rotate.X_AXIS));</span>
<span class="nc" id="L155">        front.setTranslateY(front.getTranslateY() - getSize());</span>

<span class="nc" id="L157">        up.setTranslateX(-0.5 * getSize());</span>
<span class="nc" id="L158">        up.setTranslateY(-1 * getSize());</span>
<span class="nc" id="L159">        up.setRotationAxis(Rotate.X_AXIS);</span>
<span class="nc" id="L160">        up.setRotate(-90);</span>

<span class="nc" id="L162">        down.setTranslateX(-0.5 * getSize());</span>
<span class="nc" id="L163">        down.setTranslateY(0);</span>
<span class="nc" id="L164">        down.setRotationAxis(Rotate.X_AXIS);</span>
<span class="nc" id="L165">        down.setRotate(90);</span>

<span class="nc" id="L167">        left.setTranslateX(-1 * getSize());</span>
<span class="nc" id="L168">        left.setTranslateY(-0.5 * getSize());</span>
<span class="nc" id="L169">        left.setRotationAxis(Rotate.Y_AXIS);</span>
<span class="nc" id="L170">        left.setRotate(90);</span>

<span class="nc" id="L172">        right.setTranslateX(0);</span>
<span class="nc" id="L173">        right.setTranslateY(-0.5 * getSize());</span>
<span class="nc" id="L174">        right.setRotationAxis(Rotate.Y_AXIS);</span>
<span class="nc" id="L175">        right.setRotate(-90);</span>

<span class="nc" id="L177">    }</span>
    /**
     *  for single image creates viewports and sets all views(image) to singleImg
     *  for multiple... sets images per view.
     */
    private void validateImageType(){
<span class="nc bnc" id="L183" title="All 3 branches missed.">        switch(imageType){</span>
            case SINGLE:
<span class="nc" id="L185">                loadSingleImageViewports();</span>
<span class="nc" id="L186">                break;</span>
            case MULTIPLE:
                // TODO: implement single and double properly @rrh
<span class="nc" id="L189">            	setMultipleImages();</span>
                break;
        }
<span class="nc" id="L192">    }</span>
    // TODO: change layout - Streetside cubemaps are structured as follows: @rrh
    /**
     * 01-front, 02-right, 03-back, 10-left, 11-up, 12-down
     *
     *         ____ ____ ____ ____ ____ ____
     *        |fwd |rght|back|left|top |bot |
     *        |____|____|____|____|____|____|
     *
     */

    private void loadSingleImageViewports(){
<span class="nc" id="L204">        layoutViews();</span>
<span class="nc" id="L205">        double width = singleImg.getWidth(),</span>
<span class="nc" id="L206">               height = singleImg.getHeight();</span>

        //simple check to see if cells will be square
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if(width / 4 != height / 3){</span>
<span class="nc" id="L210">            throw new UnsupportedOperationException(&quot;Image does not comply with size constraints&quot;);</span>
        }
<span class="nc" id="L212">        double cellSize = singleImg.getWidth() - singleImg.getHeight();</span>

<span class="nc" id="L214">        recalculateSize(cellSize);</span>

        double
<span class="nc" id="L217">                topx = cellSize, topy = 0,</span>

<span class="nc" id="L219">                botx = cellSize, boty = cellSize * 2,</span>

<span class="nc" id="L221">                leftx = 0, lefty = cellSize,</span>

<span class="nc" id="L223">                rightx = cellSize * 2, righty = cellSize,</span>

<span class="nc" id="L225">                fwdx = cellSize, fwdy = cellSize,</span>

<span class="nc" id="L227">                backx = cellSize * 3, backy = cellSize;</span>

        //add top padding x+, y+, width-, height
<span class="nc" id="L230">        up.setViewport(new Rectangle2D(topx , topy , cellSize, cellSize ));</span>

        //add left padding x, y+, width, height-
<span class="nc" id="L233">        left.setViewport(new Rectangle2D(leftx , lefty , cellSize - 1, cellSize - 1));</span>

        //add front padding x+, y+, width-, height
<span class="nc" id="L236">        front.setViewport(new Rectangle2D(fwdx , fwdy, cellSize , cellSize));</span>

        //add right padding x, y+, width, height-
<span class="nc" id="L239">        right.setViewport(new Rectangle2D(rightx, righty , cellSize , cellSize ));</span>

        //add back padding x, y+, width, height-
<span class="nc" id="L242">        back.setViewport(new Rectangle2D(backx + 1, backy - 1, cellSize - 1, cellSize - 1));</span>

        //add bottom padding x+, y, width-, height-
<span class="nc" id="L245">        down.setViewport(new Rectangle2D(botx, boty, cellSize , cellSize));</span>

<span class="nc bnc" id="L247" title="All 2 branches missed.">        for(ImageView v : views){</span>
<span class="nc" id="L248">            v.setImage(singleImg);</span>
        }
<span class="nc" id="L250">    }</span>



    private void recalculateSize(double cell){
<span class="nc" id="L255">        double factor = Math.floor(getSize() / cell);</span>
<span class="nc" id="L256">        setSize(cell * factor);</span>
<span class="nc" id="L257">    }</span>

	public synchronized void setImage(BufferedImage img, int position) {
<span class="nc" id="L260">		views[position].setImage(GraphicsUtils.convertBufferedImage2JavaFXImage(img));</span>

<span class="nc" id="L262">	}</span>


    private void setMultipleImages() {
<span class="nc" id="L266">		GraphicsUtils.PlatformHelper.run(() -&gt; {</span>
<span class="nc" id="L267">			layoutViews();</span>
<span class="nc" id="L268">			front.setImage(frontImg);</span>
<span class="nc" id="L269">			right.setImage(rightImg);</span>
<span class="nc" id="L270">			back.setImage(backImg);</span>
<span class="nc" id="L271">			left.setImage(leftImg);</span>
<span class="nc" id="L272">			up.setImage(upImg);</span>
<span class="nc" id="L273">			down.setImage(downImg);</span>

<span class="nc" id="L275">		});</span>
<span class="nc" id="L276">	}</span>

    public void startTimer(){
<span class="nc" id="L279">        timer = new AnimationTimer() {</span>
            @Override
            public void handle(long now) {
<span class="nc bnc" id="L282" title="All 2 branches missed.">                Transform ct = (camera != null) ? camera.getLocalToSceneTransform() : null;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                if(ct != null){</span>
<span class="nc" id="L284">                    affine.setTx(ct.getTx());</span>
<span class="nc" id="L285">                    affine.setTy(ct.getTy());</span>
<span class="nc" id="L286">                    affine.setTz(ct.getTz());</span>
                }
<span class="nc" id="L288">            }</span>
        };
<span class="nc" id="L290">        timer.start();</span>
<span class="nc" id="L291">    }</span>

    /*
        Properties
    */
<span class="nc" id="L296">    private final DoubleProperty size = new SimpleDoubleProperty(){</span>
        @Override
        protected void invalidated() {
<span class="nc bnc" id="L299" title="All 2 branches missed.">            switch(imageType){</span>
            case SINGLE:
<span class="nc" id="L301">                layoutViews();</span>
<span class="nc" id="L302">                break;</span>
            case MULTIPLE:
                break;
            }

<span class="nc" id="L307">        }</span>
    };

    public final double getSize() {
<span class="nc" id="L311">        return size.get();</span>
    }

    public final void setSize(double value) {
<span class="nc" id="L315">        size.set(value);</span>
<span class="nc" id="L316">    }</span>

    public DoubleProperty sizeProperty() {
<span class="nc" id="L319">        return size;</span>
    }

	public ImageView[] getViews() {
<span class="nc" id="L323">		return views;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>