<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CubemapBox.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MicrosoftStreetside</a> &gt; <a href="index.source.html" class="el_package">org.openstreetmap.josm.plugins.streetside.utils</a> &gt; <span class="el_source">CubemapBox.java</span></div><h1>CubemapBox.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */

package org.openstreetmap.josm.plugins.streetside.utils;

import java.awt.image.BufferedImage;

import org.openstreetmap.josm.plugins.streetside.cubemap.CubemapUtils;
import org.openstreetmap.josm.plugins.streetside.cubemap.GraphicsUtils;

import javafx.animation.AnimationTimer;
import javafx.beans.property.DoubleProperty;
import javafx.beans.property.SimpleDoubleProperty;
import javafx.geometry.Rectangle2D;
import javafx.scene.Group;
import javafx.scene.PerspectiveCamera;
import javafx.scene.image.Image;
import javafx.scene.image.ImageView;
import javafx.scene.image.WritableImage;
import javafx.scene.transform.Affine;
import javafx.scene.transform.Rotate;
import javafx.scene.transform.Transform;

/**
 *
 * @author Dub
 * @author renerr18
 */
// TODO: try making CubemapBox a singleton with lazy initialization; otherwise create factory @rrh
@SuppressWarnings(&quot;restriction&quot;)
public  class CubemapBox extends Group{

	private CubemapBox instance;

<span class="nc" id="L38">    public enum CubemapBoxImageType{</span>
<span class="nc" id="L39">        MULTIPLE, SINGLE</span>
    }

<span class="nc" id="L42">    private final Affine affine = new Affine();</span>

<span class="nc" id="L44">    private final ImageView</span>
    front = new ImageView(),
	right = new ImageView(),
	back  = new ImageView(),
	left  = new ImageView(),
    up    = new ImageView(),
    down  = new ImageView();

    {
<span class="nc" id="L53">    	front.setId(CubemapUtils.CubemapFaces.FRONT.getValue());</span>
<span class="nc" id="L54">    	right.setId(CubemapUtils.CubemapFaces.RIGHT.getValue());</span>
<span class="nc" id="L55">    	back.setId(CubemapUtils.CubemapFaces.BACK.getValue());</span>
<span class="nc" id="L56">    	left.setId(CubemapUtils.CubemapFaces.LEFT.getValue());</span>
<span class="nc" id="L57">    	up.setId(CubemapUtils.CubemapFaces.UP.getValue());</span>
<span class="nc" id="L58">        down .setId(CubemapUtils.CubemapFaces.DOWN.getValue());</span>

    }
<span class="nc" id="L61">    private final ImageView[] views = new ImageView[]{</span>
    	front,
    	right,
    	back,
    	left,
    	up,
        down
    };

	private Image
		frontImg, rightImg, backImg, leftImg, upImg, downImg, singleImg;

	private WritableImage convertedImage;

    private final PerspectiveCamera camera;
    private AnimationTimer timer;
    private final CubemapBoxImageType imageType;

    public CubemapBox(Image singleImg, double size, PerspectiveCamera camera) {
<span class="nc" id="L80">        super();</span>
<span class="nc" id="L81">        imageType = CubemapBoxImageType.SINGLE;</span>

<span class="nc" id="L83">        this.singleImg = singleImg;</span>
<span class="nc" id="L84">        this.size.set(size);</span>
<span class="nc" id="L85">        this.camera = camera;</span>

<span class="nc" id="L87">        getTransforms().add(affine);</span>

<span class="nc" id="L89">        loadImageViews();</span>

<span class="nc" id="L91">        getChildren().addAll(views);</span>
<span class="nc" id="L92">    }</span>

    // private constructor to prevent instantiation
    public CubemapBox(double size, PerspectiveCamera camera) {
<span class="nc" id="L96">        super();</span>
<span class="nc" id="L97">        imageType = CubemapBoxImageType.SINGLE;</span>

<span class="nc" id="L99">        this.size.set(size);</span>
<span class="nc" id="L100">        this.camera = camera;</span>

<span class="nc" id="L102">        getTransforms().add(affine);</span>

<span class="nc" id="L104">        loadImageViews();</span>

<span class="nc" id="L106">        getChildren().addAll(views);</span>
<span class="nc" id="L107">    }</span>

    public CubemapBox(Image frontImg, Image rightImg, Image backImg, Image leftImg, Image upImg, Image downImg, double size, PerspectiveCamera camera) {
<span class="nc" id="L110">        super();</span>
<span class="nc" id="L111">        imageType = CubemapBoxImageType.MULTIPLE;</span>

<span class="nc" id="L113">        this.frontImg = frontImg;</span>
<span class="nc" id="L114">        this.rightImg = rightImg;</span>
<span class="nc" id="L115">        this.backImg = backImg;</span>
<span class="nc" id="L116">        this.leftImg = leftImg;</span>
<span class="nc" id="L117">        this.upImg = upImg;</span>
<span class="nc" id="L118">        this.downImg = downImg;</span>
<span class="nc" id="L119">        this.size.set(size);</span>
<span class="nc" id="L120">        this.camera = camera;</span>

<span class="nc" id="L122">        loadImageViews();</span>

<span class="nc" id="L124">        getTransforms().add(affine);</span>

<span class="nc" id="L126">        getChildren().addAll(views);</span>

<span class="nc" id="L128">        startTimer();</span>
<span class="nc" id="L129">    }</span>

    public void loadImageViews(){

<span class="nc bnc" id="L133" title="All 2 branches missed.">        for(ImageView iv : views){</span>
<span class="nc" id="L134">            iv.setSmooth(true);</span>
<span class="nc" id="L135">            iv.setPreserveRatio(true);</span>
        }

<span class="nc" id="L138">        validateImageType();</span>
<span class="nc" id="L139">    }</span>

    private void layoutViews() {

<span class="nc bnc" id="L143" title="All 2 branches missed.">    	for(ImageView v : views){</span>
<span class="nc" id="L144">            v.setFitWidth(getSize());</span>
<span class="nc" id="L145">            v.setFitHeight(getSize());</span>
        }

<span class="nc" id="L148">        back.setTranslateX(-0.5 * getSize());</span>
<span class="nc" id="L149">        back.setTranslateY(-0.5 * getSize());</span>
<span class="nc" id="L150">        back.setTranslateZ(-0.5 * getSize());</span>

<span class="nc" id="L152">        front.setTranslateX(-0.5 * getSize());</span>
<span class="nc" id="L153">        front.setTranslateY(-0.5 * getSize());</span>
<span class="nc" id="L154">        front.setTranslateZ(0.5 * getSize());</span>
<span class="nc" id="L155">        front.setRotationAxis(Rotate.Z_AXIS);</span>
<span class="nc" id="L156">        front.setRotate(-180);</span>
<span class="nc" id="L157">        front.getTransforms().add(new Rotate(180,front.getFitHeight() / 2, 0,0, Rotate.X_AXIS));</span>
<span class="nc" id="L158">        front.setTranslateY(front.getTranslateY() - getSize());</span>

<span class="nc" id="L160">        up.setTranslateX(-0.5 * getSize());</span>
<span class="nc" id="L161">        up.setTranslateY(-1 * getSize());</span>
<span class="nc" id="L162">        up.setRotationAxis(Rotate.X_AXIS);</span>
<span class="nc" id="L163">        up.setRotate(-90);</span>

<span class="nc" id="L165">        down.setTranslateX(-0.5 * getSize());</span>
<span class="nc" id="L166">        down.setTranslateY(0);</span>
<span class="nc" id="L167">        down.setRotationAxis(Rotate.X_AXIS);</span>
<span class="nc" id="L168">        down.setRotate(90);</span>

<span class="nc" id="L170">        left.setTranslateX(-1 * getSize());</span>
<span class="nc" id="L171">        left.setTranslateY(-0.5 * getSize());</span>
<span class="nc" id="L172">        left.setRotationAxis(Rotate.Y_AXIS);</span>
<span class="nc" id="L173">        left.setRotate(90);</span>

<span class="nc" id="L175">        right.setTranslateX(0);</span>
<span class="nc" id="L176">        right.setTranslateY(-0.5 * getSize());</span>
<span class="nc" id="L177">        right.setRotationAxis(Rotate.Y_AXIS);</span>
<span class="nc" id="L178">        right.setRotate(-90);</span>

<span class="nc" id="L180">    }</span>
    /**
     *  for single image creates viewports and sets all views(image) to singleImg
     *  for multiple... sets images per view.
     */
    private void validateImageType(){
<span class="nc bnc" id="L186" title="All 3 branches missed.">        switch(imageType){</span>
            case SINGLE:
<span class="nc" id="L188">                loadSingleImageViewports();</span>
<span class="nc" id="L189">                break;</span>
            case MULTIPLE:
                // TODO: implement single and double properly @rrh
<span class="nc" id="L192">            	setMultipleImages();</span>
                break;
        }
<span class="nc" id="L195">    }</span>
    // TODO: change layout - Streetside cubemaps are structured as follows: @rrh
    /**
     * 01-front, 02-right, 03-back, 10-left, 11-up, 12-down
     *
     *         ____ ____ ____ ____ ____ ____
     *        |fwd |rght|back|left|top |bot |
     *        |____|____|____|____|____|____|
     *
     */

    private void loadSingleImageViewports(){
<span class="nc" id="L207">        layoutViews();</span>
<span class="nc" id="L208">        double width = singleImg.getWidth(),</span>
<span class="nc" id="L209">               height = singleImg.getHeight();</span>

        //simple check to see if cells will be square
<span class="nc bnc" id="L212" title="All 2 branches missed.">        if(width / 4 != height / 3){</span>
<span class="nc" id="L213">            throw new UnsupportedOperationException(&quot;Image does not comply with size constraints&quot;);</span>
        }
<span class="nc" id="L215">        double cellSize = singleImg.getWidth() - singleImg.getHeight();</span>

<span class="nc" id="L217">        recalculateSize(cellSize);</span>

        double
<span class="nc" id="L220">                topx = cellSize, topy = 0,</span>

<span class="nc" id="L222">                botx = cellSize, boty = cellSize * 2,</span>

<span class="nc" id="L224">                leftx = 0, lefty = cellSize,</span>

<span class="nc" id="L226">                rightx = cellSize * 2, righty = cellSize,</span>

<span class="nc" id="L228">                fwdx = cellSize, fwdy = cellSize,</span>

<span class="nc" id="L230">                backx = cellSize * 3, backy = cellSize;</span>

        //add top padding x+, y+, width-, height
<span class="nc" id="L233">        up.setViewport(new Rectangle2D(topx , topy , cellSize, cellSize ));</span>

        //add left padding x, y+, width, height-
<span class="nc" id="L236">        left.setViewport(new Rectangle2D(leftx , lefty , cellSize - 1, cellSize - 1));</span>

        //add front padding x+, y+, width-, height
<span class="nc" id="L239">        front.setViewport(new Rectangle2D(fwdx , fwdy, cellSize , cellSize));</span>

        //add right padding x, y+, width, height-
<span class="nc" id="L242">        right.setViewport(new Rectangle2D(rightx, righty , cellSize , cellSize ));</span>

        //add back padding x, y+, width, height-
<span class="nc" id="L245">        back.setViewport(new Rectangle2D(backx + 1, backy - 1, cellSize - 1, cellSize - 1));</span>

        //add bottom padding x+, y, width-, height-
<span class="nc" id="L248">        down.setViewport(new Rectangle2D(botx, boty, cellSize , cellSize));</span>

<span class="nc bnc" id="L250" title="All 2 branches missed.">        for(ImageView v : views){</span>
<span class="nc" id="L251">            v.setImage(singleImg);</span>
        }
<span class="nc" id="L253">    }</span>



    private void recalculateSize(double cell){
<span class="nc" id="L258">        double factor = Math.floor(getSize() / cell);</span>
<span class="nc" id="L259">        setSize(cell * factor);</span>
<span class="nc" id="L260">    }</span>

	public synchronized void setImage(BufferedImage img, int position) {
<span class="nc" id="L263">		views[position].setImage(GraphicsUtils.convertBufferedImage2JavaFXImage(img));</span>

<span class="nc" id="L265">	}</span>


    private void setMultipleImages() {
<span class="nc" id="L269">		GraphicsUtils.PlatformHelper.run(() -&gt; {</span>
<span class="nc" id="L270">			layoutViews();</span>
<span class="nc" id="L271">			front.setImage(frontImg);</span>
<span class="nc" id="L272">			right.setImage(rightImg);</span>
<span class="nc" id="L273">			back.setImage(backImg);</span>
<span class="nc" id="L274">			left.setImage(leftImg);</span>
<span class="nc" id="L275">			up.setImage(upImg);</span>
<span class="nc" id="L276">			down.setImage(downImg);</span>

<span class="nc" id="L278">		});</span>
<span class="nc" id="L279">	}</span>

    public void startTimer(){
<span class="nc" id="L282">        timer = new AnimationTimer() {</span>
            @Override
            public void handle(long now) {
<span class="nc bnc" id="L285" title="All 2 branches missed.">                Transform ct = (camera != null) ? camera.getLocalToSceneTransform() : null;</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">                if(ct != null){</span>
<span class="nc" id="L287">                    affine.setTx(ct.getTx());</span>
<span class="nc" id="L288">                    affine.setTy(ct.getTy());</span>
<span class="nc" id="L289">                    affine.setTz(ct.getTz());</span>
                }
<span class="nc" id="L291">            }</span>
        };
<span class="nc" id="L293">        timer.start();</span>
<span class="nc" id="L294">    }</span>

    /*
        Properties
    */
<span class="nc" id="L299">    private final DoubleProperty size = new SimpleDoubleProperty(){</span>
        @Override
        protected void invalidated() {
<span class="nc bnc" id="L302" title="All 2 branches missed.">            switch(imageType){</span>
            case SINGLE:
<span class="nc" id="L304">                layoutViews();</span>
<span class="nc" id="L305">                break;</span>
            case MULTIPLE:
                break;
            }

<span class="nc" id="L310">        }</span>
    };

    public final double getSize() {
<span class="nc" id="L314">        return size.get();</span>
    }

    public final void setSize(double value) {
<span class="nc" id="L318">        size.set(value);</span>
<span class="nc" id="L319">    }</span>

    public DoubleProperty sizeProperty() {
<span class="nc" id="L322">        return size;</span>
    }

	public ImageView[] getViews() {
<span class="nc" id="L326">		return views;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>